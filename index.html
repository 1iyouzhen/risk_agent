<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èAIé£é™©è¯„ä¼°ç³»ç»Ÿ - æ™ºèƒ½é£æ§åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-indicator span {
            animation: blink 1.4s infinite;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes blink {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        .feature-card:hover {
            transform: translateY(-4px);
            transition: all 0.3s ease;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                            <i class="fas fa-shield-alt text-white text-xl"></i>
                        </div>
                        <span class="text-xl font-bold text-gray-900">é‡‘èAIé£æ§</span>
                    </div>
                    <div class="hidden md:flex space-x-6">
                        <a href="#" class="text-gray-700 hover:text-purple-600 font-medium transition">é£é™©è¯„ä¼°</a>
                        <a href="#" class="text-gray-700 hover:text-purple-600 font-medium transition">çŸ¥è¯†å›¾è°±</a>
                        <a href="#" class="text-gray-700 hover:text-purple-600 font-medium transition">æŠ¥å‘Šä¸­å¿ƒ</a>
                        <a href="#" class="text-gray-700 hover:text-purple-600 font-medium transition">APIæ–‡æ¡£</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div id="userSection" style="display: none;">
                        <div class="flex items-center space-x-3">
                            <span id="userName" class="text-gray-700 font-medium"></span>
                            <button id="logoutBtn" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
                                é€€å‡º
                            </button>
                        </div>
                    </div>
                    <button id="loginBtn" class="px-6 py-2 gradient-bg text-white rounded-lg hover:opacity-90 transition font-medium">
                        ç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <div class="pt-20">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- å·¦ä¾§è¾¹æ  - å†å²å¯¹è¯ -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-200 p-6 h-[calc(100vh-140px)] overflow-y-auto scrollbar-hide">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">å†å²å¯¹è¯</h2>
                        <button class="p-2 hover:bg-gray-100 rounded-lg transition">
                            <i class="fas fa-plus text-gray-600"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg cursor-pointer hover:bg-purple-100 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 mb-1">ä¸‰æœ¨é›†å›¢é£é™©è¯„ä¼°</p>
                                    <p class="text-xs text-gray-500">2å°æ—¶å‰</p>
                                </div>
                                <i class="fas fa-ellipsis-v text-gray-400"></i>
                            </div>
                        </div>

                        <div class="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 mb-1">å†œäº§å“è¡Œä¸šç³»ç»Ÿæ€§é£é™©</p>
                                    <p class="text-xs text-gray-500">æ˜¨å¤©</p>
                                </div>
                                <i class="fas fa-ellipsis-v text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 mb-1">å†€å‡¯è‚¡ä»½ä¿¡ç”¨è¯„åˆ†åˆ†æ</p>
                                    <p class="text-xs text-gray-500">3å¤©å‰</p>
                                </div>
                                <i class="fas fa-ellipsis-v text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 mb-1">æµ·èºæ–°æå…³è”ä¼ä¸šé£é™©</p>
                                    <p class="text-xs text-gray-500">1å‘¨å‰</p>
                                </div>
                                <i class="fas fa-ellipsis-v text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´ä¸»èŠå¤©åŒº -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-[calc(100vh-140px)]">
                    
                    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide">
                        
                        <!-- æ¬¢è¿ç•Œé¢ -->
                        <div id="welcomeScreen" class="flex flex-col items-center justify-center h-full text-center">
                            <div class="w-20 h-20 gradient-bg rounded-2xl flex items-center justify-center mb-6">
                                <i class="fas fa-robot text-white text-4xl"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-3">é‡‘èAIé£é™©è¯„ä¼°åŠ©æ‰‹</h1>
                            <p class="text-gray-600 mb-8 max-w-2xl">
                                é›†æˆçŸ¥è¯†å›¾è°±ã€RAGæ£€ç´¢å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹çš„æ™ºèƒ½é£æ§ç³»ç»Ÿ<br>
                                ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„é£é™©è¯„ä¼°ã€é¢„è­¦å’Œå†³ç­–æ”¯æŒæœåŠ¡
                            </p>
                            
                            <!-- å¿«æ·åŠŸèƒ½å¡ç‰‡ -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
                                <div class="feature-card p-5 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl border border-purple-200 cursor-pointer text-left">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-chart-line text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 mb-1">é£é™©è¯„ä¼°</h3>
                                            <p class="text-sm text-gray-600">åŸºäºå¤šç»´åº¦æ•°æ®åˆ†æä¼ä¸šé£é™©çŠ¶å†µ</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="feature-card p-5 bg-gradient-to-br from-green-50 to-teal-50 rounded-xl border border-green-200 cursor-pointer text-left">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-project-diagram text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 mb-1">å…³ç³»å›¾è°±</h3>
                                            <p class="text-sm text-gray-600">åˆ†æä¼ä¸šå…³è”å…³ç³»å’Œé£é™©ä¼ å¯¼</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="feature-card p-5 bg-gradient-to-br from-orange-50 to-red-50 rounded-xl border border-orange-200 cursor-pointer text-left">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-orange-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-file-alt text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 mb-1">ç”ŸæˆæŠ¥å‘Š</h3>
                                            <p class="text-sm text-gray-600">è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–é£é™©è¯„ä¼°æŠ¥å‘Š</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="feature-card p-5 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 cursor-pointer text-left">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <i class="fas fa-brain text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-gray-900 mb-1">æ™ºèƒ½å†³ç­–</h3>
                                            <p class="text-sm text-gray-600">æä¾›ä¸ªæ€§åŒ–é£é™©åº”å¯¹å»ºè®®</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ç¤ºä¾‹é—®é¢˜ -->
                            <div class="mt-8 w-full max-w-3xl">
                                <p class="text-sm text-gray-500 mb-3">è¯•è¯•è¿™äº›é—®é¢˜ï¼š</p>
                                <div class="flex flex-wrap gap-2">
                                    <button class="example-question px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:border-purple-500 hover:text-purple-600 transition">
                                        æŸ¥è¯¢ä¸‰æœ¨é›†å›¢çš„æœ€æ–°é£é™©çŠ¶å†µ
                                    </button>
                                    <button class="example-question px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:border-purple-500 hover:text-purple-600 transition">
                                        åˆ†æå†œäº§å“è¡Œä¸šçš„ç³»ç»Ÿæ€§é£é™©
                                    </button>
                                    <button class="example-question px-4 py-2 bg-white border border-gray-300 rounded-full text-sm text-gray-700 hover:border-purple-500 hover:text-purple-600 transition">
                                        ç”Ÿæˆæµ·èºæ–°æçš„é£é™©è¯„ä¼°æŠ¥å‘Š
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="border-t border-gray-200 p-4">
                        <div class="flex items-end space-x-3">
                            <div class="flex-1 relative">
                                <textarea 
                                    id="userInput" 
                                    rows="1" 
                                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæŸ¥è¯¢æŸä¼ä¸šçš„é£é™©çŠ¶å†µ..." 
                                    class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                    style="max-height: 200px;"
                                ></textarea>
                                <button class="absolute right-3 bottom-3 text-gray-400 hover:text-gray-600 transition">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                            </div>
                            <button 
                                id="sendButton" 
                                class="px-6 py-3 gradient-bg text-white rounded-xl hover:opacity-90 transition font-medium flex items-center space-x-2"
                            >
                                <span>å‘é€</span>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle"></i> 
                            AIç”Ÿæˆçš„å†…å®¹å¯èƒ½ä¸å‡†ç¡®ï¼Œè¯·è°¨æ…ä½¿ç”¨å¹¶æ ¸å®é‡è¦ä¿¡æ¯
                        </p>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">ç™»å½•ç³»ç»Ÿ</h2>
                <p class="text-gray-600 mt-2">è®¿é—®é‡‘èAIé£é™©è¯„ä¼°ç³»ç»Ÿ</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                        required
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="è¯·è¾“å…¥å¯†ç "
                        required
                    >
                </div>
                
                <div id="loginError" class="text-red-500 text-sm" style="display: none;"></div>
                
                <button 
                    type="submit" 
                    class="w-full py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition font-medium"
                >
                    ç™»å½•
                </button>
                
                <button 
                    type="button" 
                    id="cancelLogin"
                    class="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
                >
                    å–æ¶ˆ
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>æµ‹è¯•è´¦å·: admin / admin123</p>
            </div>
        </div>
    </div>

    <!-- JavaScript äº¤äº’é€»è¾‘ -->
    <script>
        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:8000';
        
        // å…¨å±€çŠ¶æ€
        let currentUser = null;
        let authToken = null;
        let conversationHistory = [];
        
        const chatMessages = document.getElementById('chatMessages');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const exampleQuestions = document.querySelectorAll('.example-question');
        
        // ç™»å½•ç›¸å…³å…ƒç´ 
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginForm = document.getElementById('loginForm');
        const cancelLogin = document.getElementById('cancelLogin');
        const userSection = document.getElementById('userSection');
        const loginError = document.getElementById('loginError');
        
        // åˆå§‹åŒ–ï¼šæ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
        window.addEventListener('load', function() {
            const savedUser = localStorage.getItem('currentUser');
            const savedToken = localStorage.getItem('authToken');
            if (savedUser && savedToken) {
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                updateUIAfterLogin();
            }
        });
        
        // ç™»å½•æŒ‰é’®ç‚¹å‡»
        loginBtn.addEventListener('click', function() {
            loginModal.classList.add('active');
        });
        
        // å–æ¶ˆç™»å½•
        cancelLogin.addEventListener('click', function() {
            loginModal.classList.remove('active');
            loginForm.reset();
            loginError.style.display = 'none';
        });
        
        // ç™»å½•è¡¨å•æäº¤
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    authToken = data.token;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('authToken', authToken);
                    updateUIAfterLogin();
                    loginModal.classList.remove('active');
                    loginForm.reset();
                    loginError.style.display = 'none';
                } else {
                    loginError.textContent = data.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
                    loginError.style.display = 'block';
                }
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                loginError.textContent = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨';
                loginError.style.display = 'block';
            }
        });
        
        // é€€å‡ºç™»å½•
        logoutBtn.addEventListener('click', function() {
            currentUser = null;
            authToken = null;
            conversationHistory = [];
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            updateUIAfterLogout();
        });
        
        function updateUIAfterLogin() {
            loginBtn.style.display = 'none';
            userSection.style.display = 'block';
            document.getElementById('userName').textContent = currentUser.username;
        }
        
        function updateUIAfterLogout() {
            loginBtn.style.display = 'block';
            userSection.style.display = 'none';
            // æ¸…ç©ºèŠå¤©è®°å½•
            chatMessages.innerHTML = '';
            if (welcomeScreen) {
                welcomeScreen.style.display = 'flex';
            }
        }
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        
        // ç¤ºä¾‹é—®é¢˜ç‚¹å‡»
        exampleQuestions.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.textContent.trim();
                userInput.value = question;
                sendMessage();
            });
        });
        
        // å‘é€æ¶ˆæ¯
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨');
                loginModal.classList.add('active');
                return;
            }
            
            // éšè—æ¬¢è¿ç•Œé¢
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            userInput.value = '';
            userInput.style.height = 'auto';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showTypingIndicator();
            
            try {
                // è°ƒç”¨åç«¯API
                const response = await fetch(`${API_BASE_URL}/api/chat/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        query: message,
                        history: conversationHistory.slice(-10) // åªå‘é€æœ€è¿‘10è½®å¯¹è¯
                    })
                });
                
                hideTypingIndicator();
                
                if (response.ok) {
                    const data = await response.json();
                    const formattedResponse = formatAIResponse(data);
                    addMessage(formattedResponse, 'assistant');
                    conversationHistory.push({ role: 'assistant', content: data.answer });
                } else {
                    const errorData = await response.json();
                    addMessage(`<p class="text-red-600">é”™è¯¯: ${errorData.message || 'æŸ¥è¯¢å¤±è´¥'}</p>`, 'assistant');
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('æŸ¥è¯¢é”™è¯¯:', error);
                addMessage(`<p class="text-red-600">è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨</p>`, 'assistant');
            }
        }
        
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3';
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-gray-600 text-sm"></i>
                    </div>
                    <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-3">
                        <p class="text-gray-900">${escapeHtml(content)}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 w-8 h-8 gradient-bg rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <div class="bg-white border border-gray-200 rounded-2xl px-4 py-3">
                            ${content}
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'chat-message flex items-start space-x-3';
            indicator.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 gradient-bg rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="flex-1 bg-white border border-gray-200 rounded-2xl px-4 py-3">
                    <div class="typing-indicator flex space-x-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function generateResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('ä¸‰æœ¨é›†å›¢')) {
                return `
                    <p class="text-gray-900 mb-4">æ ¹æ®æœ€æ–°æ•°æ®åˆ†æï¼Œä¸‰æœ¨é›†å›¢çš„é£é™©è¯„ä¼°ç»“æœå¦‚ä¸‹ï¼š</p>
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                            <span class="font-semibold text-gray-900">é£é™©è¯„åˆ†ï¼š0.72ï¼ˆä¸­é«˜é£é™©ï¼‰</span>
                        </div>
                        <p class="text-sm text-gray-700">è¯„ä¼°æ—¶é—´ï¼š2023-11-27</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">ğŸ“Š ä¸»è¦é£é™©å› ç´ ï¼š</h4>
                            <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                <li>â€¢ ä¿¡ç”¨è¯„åˆ†åä½ï¼ˆ620åˆ†ï¼‰ï¼Œä½äºè¡Œä¸šå¹³å‡æ°´å¹³</li>
                                <li>â€¢ è¿‘12ä¸ªæœˆå­˜åœ¨3æ¬¡è¿çº¦è®°å½•</li>
                                <li>â€¢ å¸‚åœºæŒ‡æ•°æ³¢åŠ¨è¾ƒå¤§ï¼Œå¤–éƒ¨ç¯å¢ƒä¸åˆ©</li>
                                <li>â€¢ ç°é‡‘æµå‹åŠ›å¢åŠ ï¼ŒæµåŠ¨æ€§é£é™©ä¸Šå‡</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">ğŸ’¡ åº”å¯¹å»ºè®®ï¼š</h4>
                            <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                <li>â€¢ å»ºè®®åŠ å¼ºè´·åç®¡ç†ï¼Œå¢åŠ ç›‘æ§é¢‘æ¬¡è‡³æ¯å‘¨ä¸€æ¬¡</li>
                                <li>â€¢ è€ƒè™‘è¦æ±‚æä¾›é¢å¤–æ‹…ä¿æˆ–æŠµæŠ¼ç‰©</li>
                                <li>â€¢ å»ºè®®è´­ä¹°ä¿¡ç”¨ä¿é™©è½¬ç§»éƒ¨åˆ†é£é™©</li>
                                <li>â€¢ å¯†åˆ‡å…³æ³¨å…³è”ä¼ä¸šé£é™©ä¼ å¯¼æƒ…å†µ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200 transition">
                            <i class="fas fa-download mr-1"></i>ä¸‹è½½å®Œæ•´æŠ¥å‘Š
                        </button>
                        <button class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 transition">
                            <i class="fas fa-project-diagram mr-1"></i>æŸ¥çœ‹å…³ç³»å›¾è°±
                        </button>
                    </div>
                `;
            }

            if (lowerMessage.includes('å†œäº§å“') || lowerMessage.includes('ç³»ç»Ÿæ€§é£é™©')) {
                return `
                    <p class="text-gray-900 mb-4">å†œäº§å“è¡Œä¸šç³»ç»Ÿæ€§é£é™©åˆ†ææŠ¥å‘Šï¼š</p>
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-chart-line text-yellow-600"></i>
                            <span class="font-semibold text-gray-900">è¡Œä¸šé£é™©æŒ‡æ•°ï¼š0.58ï¼ˆä¸­ç­‰é£é™©ï¼‰</span>
                        </div>
                        <p class="text-sm text-gray-700">åˆ†æå‘¨æœŸï¼š2023å¹´1æœˆ-11æœˆ</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">ğŸ” é£é™©ä¼ å¯¼è·¯å¾„ï¼š</h4>
                            <div class="text-sm text-gray-700 space-y-2">
                                <p>é€šè¿‡çŸ¥è¯†å›¾è°±åˆ†æå‘ç°ï¼Œå†œäº§å“è¡Œä¸šå­˜åœ¨ä»¥ä¸‹é£é™©ä¼ å¯¼é“¾ï¼š</p>
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                    <p class="font-mono text-xs">åŸææ–™ä¾›åº”å•† â†’ å†œäº§å“åŠ å·¥ä¼ä¸š â†’ æ‰¹å‘å•† â†’ é›¶å”®ç»ˆç«¯</p>
                                </div>
                                <p>ä¸Šæ¸¸ä¾›åº”é“¾æ³¢åŠ¨å¯¹ä¸‹æ¸¸ä¼ä¸šå½±å“æ˜¾è‘—ï¼Œå»ºè®®å…³æ³¨ï¼š</p>
                                <ul class="ml-4 space-y-1">
                                    <li>â€¢ å­£èŠ‚æ€§ä»·æ ¼æ³¢åŠ¨é£é™©</li>
                                    <li>â€¢ æ”¿ç­–è°ƒæ§å½±å“</li>
                                    <li>â€¢ å›½é™…å¸‚åœºä»·æ ¼è”åŠ¨</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">ğŸ“ˆ è¶‹åŠ¿é¢„æµ‹ï¼š</h4>
                            <p class="text-sm text-gray-700">åŸºäºPatchTSTæ¨¡å‹é¢„æµ‹ï¼Œæœªæ¥3ä¸ªæœˆè¡Œä¸šé£é™©æŒ‡æ•°é¢„è®¡åœ¨0.55-0.62åŒºé—´æ³¢åŠ¨ï¼Œå»ºè®®é‡‡å–ç›‘æµ‹å‹ç­–ç•¥ã€‚</p>
                        </div>
                    </div>
                `;
            }

            if (lowerMessage.includes('æµ·èºæ–°æ') || lowerMessage.includes('æŠ¥å‘Š')) {
                return `
                    <p class="text-gray-900 mb-4">æµ·èºæ–°æé£é™©è¯„ä¼°æŠ¥å‘Šå·²ç”Ÿæˆï¼š</p>
                    <div class="bg-gradient-to-r from-green-50 to-teal-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <span class="font-semibold text-gray-900">é£é™©è¯„åˆ†ï¼š0.42ï¼ˆä½é£é™©ï¼‰</span>
                        </div>
                        <p class="text-sm text-gray-700">ä¼ä¸šè¿è¥çŠ¶å†µè‰¯å¥½ï¼Œè´¢åŠ¡æŒ‡æ ‡å¥åº·</p>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                        <h4 class="font-semibold text-gray-900 mb-3">ğŸ“„ æŠ¥å‘Šæ‘˜è¦</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500 mb-1">ä¿¡ç”¨è¯„åˆ†</p>
                                <p class="font-semibold text-gray-900">720åˆ†</p>
                            </div>
                            <div>
                                <p class="text-gray-500 mb-1">è¿çº¦è®°å½•</p>
                                <p class="font-semibold text-gray-900">0æ¬¡</p>
                            </div>
                            <div>
                                <p class="text-gray-500 mb-1">å¸‚åœºè¡¨ç°</p>
                                <p class="font-semibold text-green-600">ç¨³å®šå¢é•¿</p>
                            </div>
                            <div>
                                <p class="text-gray-500 mb-1">å…³è”é£é™©</p>
                                <p class="font-semibold text-green-600">ä½</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="px-4 py-2 gradient-bg text-white rounded-lg text-sm hover:opacity-90 transition">
                            <i class="fas fa-file-pdf mr-1"></i>ä¸‹è½½PDFæŠ¥å‘Š
                        </button>
                        <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200 transition">
                            <i class="fas fa-file-csv mr-1"></i>å¯¼å‡ºCSV
                        </button>
                    </div>
                `;
            }

            // é»˜è®¤å“åº”
            return `
                <p class="text-gray-900 mb-4">æˆ‘æ˜¯é‡‘èAIé£é™©è¯„ä¼°åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                <div class="space-y-2">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check text-purple-500 mt-1"></i>
                        <p class="text-sm text-gray-700">æŸ¥è¯¢ä¼ä¸šçš„å®æ—¶é£é™©è¯„åˆ†å’Œå†å²è¶‹åŠ¿</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check text-purple-500 mt-1"></i>
                        <p class="text-sm text-gray-700">åˆ†æè¡Œä¸šç³»ç»Ÿæ€§é£é™©å’Œä¼ å¯¼è·¯å¾„</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check text-purple-500 mt-1"></i>
                        <p class="text-sm text-gray-700">ç”Ÿæˆç»“æ„åŒ–é£é™©è¯„ä¼°æŠ¥å‘Šï¼ˆæ”¯æŒPDF/CSV/HTMLï¼‰</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check text-purple-500 mt-1"></i>
                        <p class="text-sm text-gray-700">æä¾›åŸºäºçŸ¥è¯†å›¾è°±çš„å…³è”ä¼ä¸šé£é™©åˆ†æ</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check text-purple-500 mt-1"></i>
                        <p class="text-sm text-gray-700">ç»™å‡ºä¸ªæ€§åŒ–çš„é£é™©åº”å¯¹å»ºè®®å’Œå†³ç­–æ”¯æŒ</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-lightbulb mr-1"></i>
                        æç¤ºï¼šæ‚¨å¯ä»¥è¯¢é—®å…·ä½“ä¼ä¸šï¼ˆå¦‚"ä¸‰æœ¨é›†å›¢"ã€"å†€å‡¯è‚¡ä»½"ï¼‰çš„é£é™©çŠ¶å†µï¼Œæˆ–è¯·æ±‚ç”Ÿæˆè¯„ä¼°æŠ¥å‘Šã€‚
                    </p>
                </div>
            `;
        }
        
        function formatAIResponse(data) {
            // æ ¼å¼åŒ–åç«¯è¿”å›çš„æ•°æ®
            let html = '';
            
            if (data.answer) {
                html += `<div class="text-gray-900 mb-4">${escapeHtml(data.answer).replace(/\n/g, '<br>')}</div>`;
            }
            
            // æ˜¾ç¤ºé£é™©è¯„åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.risk_score !== undefined) {
                const riskLevel = data.risk_score >= 0.7 ? 'é«˜é£é™©' : data.risk_score >= 0.5 ? 'ä¸­é£é™©' : 'ä½é£é™©';
                const riskColor = data.risk_score >= 0.7 ? 'red' : data.risk_score >= 0.5 ? 'yellow' : 'green';
                html += `
                    <div class="bg-gradient-to-r from-${riskColor}-50 to-${riskColor}-100 border border-${riskColor}-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-chart-line text-${riskColor}-600"></i>
                            <span class="font-semibold text-gray-900">é£é™©è¯„åˆ†ï¼š${data.risk_score.toFixed(4)}ï¼ˆ${riskLevel}ï¼‰</span>
                        </div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæ£€ç´¢æ¥æº
            if (data.hits && data.hits.length > 0) {
                html += `
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800 mb-2">
                            <i class="fas fa-database mr-1"></i>
                            æ£€ç´¢åˆ° ${data.hits.length} æ¡ç›¸å…³ä¿¡æ¯
                        </p>
                        <details class="text-xs text-blue-700">
                            <summary class="cursor-pointer hover:text-blue-900">æŸ¥çœ‹æ£€ç´¢æ¥æº</summary>
                            <ul class="mt-2 space-y-1 ml-4">
                                ${data.hits.map((hit, i) => `<li>${i+1}. ${escapeHtml(hit.text?.substring(0, 100) || '')}...</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            }
            
            return html || '<p class="text-gray-600">æš‚æ— ç›¸å…³ä¿¡æ¯</p>';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
