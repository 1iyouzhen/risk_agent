# 金融AI风险评估系统 - 完整启动指南

## 🚀 快速启动（3步）

### 1. 初始化数据库
```bash
python app.py --demo
```
这将生成模拟数据并初始化系统（约需1-2分钟）

### 2. 启动后端服务
```bash
# Windows用户
start_server.bat

# 或手动启动
python auth_server.py
```
看到 "Application startup complete" 表示启动成功

### 3. 打开前端界面
- 直接双击打开 `index.html`
- 或使用浏览器访问 `file:///你的路径/index.html`

### 4. 登录系统
- 用户名：`admin`
- 密码：`admin123`

---

## 📋 系统架构说明

### 后端服务（auth_server.py）
- **端口**：8000
- **API文档**：http://localhost:8000/docs
- **功能**：
  - 用户认证（登录/登出）
  - 智能查询（RAG检索 + LLM生成）
  - 风险评估
  - 历史记录查询

### 前端界面（index.html）
- **技术栈**：HTML5 + Tailwind CSS + Vanilla JS
- **功能**：
  - 用户登录界面
  - 多轮对话聊天
  - 结构化报告展示
  - 检索来源可视化

### 核心模块（src/agent/）
- **llm_client.py**：LLM调用封装
- **retriever.py**：多源RAG检索
- **storage.py**：SQLite数据存储
- **vector_store.py**：向量数据库
- **neo4j_client.py**：知识图谱查询

---

## 🔧 配置说明

### 环境变量（可选）

创建 `.env` 文件或设置系统环境变量：

```bash
# LLM配置（已内置默认值）
OPENAI_API_KEY=sk-09a2b98b38ff4d0b85b739a35e7be033
OPENAI_BASE_URL=https://api.deepseek.com
OPENAI_CHAT_MODEL=deepseek-chat

# 嵌入模型配置
EMBED_PROVIDER=baai  # 或 openai
BAAI_MODEL=BAAI/bge-m3

# Neo4j配置（可选）
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password

# RAG配置
RAG_TOP_K=10
RAG_MIN_SCORE=0.1
```

### 数据库文件
- `risk_agent.sqlite`：主数据库（评估记录、报告、特征）
- `rag_storage.db`：向量存储数据库

---

## 💡 使用示例

### 1. 查询企业风险
```
查询三木集团的最新风险状况
```

**系统流程**：
1. 从SQLite检索历史评估记录
2. 从向量库检索相似案例
3. 从知识库检索专业知识
4. 从Neo4j查询关联关系
5. 调用LLM生成结构化报告

**输出格式**：
```
【主要风险】
• 信用评分偏低（620分）
• 近12个月违约3次
• 市场指数波动较大

【指标说明】
• credit_score: 低于行业平均水平
• delinquencies: 风险较高
• market_index: 系统性风险增加

【应对建议】
• 加强贷后管理，增加监控频次
• 要求额外担保或抵押物
• 购买信用保险转移风险
```

### 2. 行业风险分析
```
分析农产品行业的系统性风险
```

### 3. 生成评估报告
```
生成海螺新材的风险评估报告
```

### 4. 关系图谱查询
```
查询三木集团的关联企业风险
```

---

## 🔍 API接口说明

### 认证接口

#### POST /api/auth/login
登录获取Token
```json
{
  "username": "admin",
  "password": "admin123"
}
```

#### POST /api/auth/logout
退出登录

### 查询接口

#### POST /api/chat/query
智能查询（核心接口）
```json
{
  "query": "查询三木集团的风险状况",
  "history": [
    {"role": "user", "content": "之前的问题"},
    {"role": "assistant", "content": "之前的回答"}
  ]
}
```

**响应示例**：
```json
{
  "success": true,
  "query": "查询三木集团的风险状况",
  "answer": "【主要风险】\n• ...",
  "hits": [
    {
      "source": "history",
      "text": "...",
      "score": 0.85
    }
  ],
  "sources_stats": {
    "history": 3,
    "knowledge": 2,
    "vector": 2
  },
  "valid": true,
  "timestamp": "2025-11-15T10:30:00"
}
```

### 风险评估接口

#### POST /api/risk/assess
评估企业风险
```json
{
  "entity_id": "测试企业",
  "data": {
    "amount": 1000.0,
    "income": 5000,
    "credit_score": 650,
    "delinquencies": 2,
    "market_index": 1200,
    "timestamp": "2023-11-15"
  }
}
```

#### GET /api/risk/history/{entity_id}
查询历史记录

---

## 🎯 核心功能详解

### 1. RAG检索系统

**多源检索策略**：
- **历史记录**：从SQLite检索相似评估案例
- **知识库**：从专业文档检索相关知识
- **向量库**：基于语义相似度检索
- **图数据库**：查询企业关联关系

**相关性评分**：
- 使用余弦相似度计算
- 支持稠密向量和稀疏向量
- 可配置最小分数阈值

### 2. LLM生成系统

**Prompt工程**：
```python
system_prompt = """你是专业的金融风控分析师。
请基于提供的检索证据回答用户问题。

要求：
1. 如果检索证据不足，明确告知
2. 输出结构化回答（主要风险、指标说明、应对建议）
3. 保持专业、准确、简洁
4. 引用检索证据中的具体数据
"""
```

**上下文构建**：
- 检索证据（按来源分类）
- 对话历史（最近3轮）
- 用户查询

### 3. 前端展示系统

**结构化解析**：
- 自动识别【主要风险】【指标说明】【应对建议】
- 分块展示，颜色区分
- 列表格式化

**检索可视化**：
- 来源统计（饼图/标签）
- 详情展开（可折叠）
- 相关度评分

---

## 🐛 故障排除

### 问题1：后端启动失败
```
ModuleNotFoundError: No module named 'fastapi'
```
**解决**：
```bash
pip install fastapi uvicorn python-multipart
```

### 问题2：前端无法连接后端
```
连接服务器失败
```
**检查**：
1. 后端是否启动（访问 http://localhost:8000/docs）
2. 端口是否被占用
3. 浏览器控制台是否有CORS错误

### 问题3：查询返回"知识库中暂无相关信息"
**原因**：数据库未初始化或查询的企业不存在

**解决**：
```bash
# 初始化数据库
python app.py --demo

# 查看已有企业
python -c "import sqlite3; conn = sqlite3.connect('risk_agent.sqlite'); print(conn.execute('SELECT DISTINCT entity_id FROM assessments').fetchall())"
```

### 问题4：LLM调用失败
**检查**：
1. API Key是否正确
2. 网络是否可访问API地址
3. 查看后端日志中的错误信息

---

## 📊 数据说明

### 已初始化的企业（demo模式）
- 三木集团
- 冀凯股份
- 农产品
- 海螺新材
- 胜利股份

每个企业有12个月的历史数据（2023年1月-11月）

### 数据特征
- `amount`：交易金额
- `income`：收入水平
- `credit_score`：信用评分（300-850）
- `delinquencies`：违约次数
- `market_index`：市场指数

---

## 🔐 安全建议

### 生产环境部署

1. **修改默认密码**
```python
# 在auth_server.py中更新
USERS_DB = {
    "admin": {
        "password_hash": hashlib.sha256("your_strong_password".encode()).hexdigest()
    }
}
```

2. **限制CORS来源**
```python
allow_origins=["https://yourdomain.com"]
```

3. **使用HTTPS**
```bash
uvicorn auth_server:app --ssl-keyfile=key.pem --ssl-certfile=cert.pem
```

4. **使用真实数据库**
- 替换SQLite为PostgreSQL/MySQL
- 使用Redis存储Token

---

## 📈 性能优化

### 1. 向量检索加速
```bash
pip install faiss-cpu
```

### 2. 缓存热点查询
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_query(query: str):
    pass
```

### 3. 批量处理
```bash
# 批量评估
python app.py --assess --input_csv large_dataset.csv
```

---

## 📝 开发指南

### 添加新的检索源
```python
# 在retriever.py中添加
def retrieve_all(...):
    # 现有检索逻辑
    
    # 添加新的检索源
    try:
        custom_results = your_custom_retriever(query_text)
        for item in custom_results:
            hits.append({
                "source": "custom",
                "text": item["text"],
                "score": item["score"]
            })
    except Exception:
        pass
```

### 自定义Prompt
```python
# 在auth_server.py的chat_query函数中修改
system_prompt = """你的自定义Prompt"""
```

### 添加新的API端点
```python
@app.post("/api/custom/endpoint")
async def custom_endpoint(username: str = Depends(verify_token)):
    # 自定义逻辑
    return {"result": "success"}
```

---

## 🎓 学习资源

### 相关技术
- **FastAPI**：https://fastapi.tiangolo.com/
- **RAG**：Retrieval-Augmented Generation
- **Neo4j**：https://neo4j.com/docs/
- **Sentence-Transformers**：https://www.sbert.net/

### 项目文档
- `README.md`：项目概述
- `README_WEB.md`：Web界面说明
- `DEBUG_GUIDE.md`：调试指南

---

## 支持

如有问题，请：
1. 查看本文档的故障排除部分
2. 查看后端日志（控制台输出）
3. 查看浏览器控制台（F12）
4. 提交Issue或联系维护者

---

**祝使用愉快！** 🎉
